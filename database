
CREATE TABLE IF NOT EXISTS vaitro (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(100) NOT NULL UNIQUE
) ENGINE=InnoDB CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS nguoi_dung (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ho_ten VARCHAR(150) NOT NULL,
  email VARCHAR(255) NOT NULL UNIQUE,
  mat_khau VARCHAR(255) NOT NULL,
  role_id BIGINT UNSIGNED NOT NULL,
  ngay_tao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (role_id) REFERENCES vaitro(id)
) ENGINE=InnoDB CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS nha_cung_cap (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(200) NOT NULL,
  lien_he VARCHAR(255) DEFAULT NULL
)

CREATE TABLE IF NOT EXISTS danh_muc (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(150) NOT NULL,
  slug VARCHAR(200) UNIQUE,
  images TEXT DEFAULT NULL, -- JSON array của URL ảnh
  trang_thai TINYINT NOT NULL DEFAULT 1
) ENGINE=InnoDB CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS san_pham (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ma_sku VARCHAR(100) UNIQUE,
  ten VARCHAR(255) NOT NULL,
  danh_muc_id BIGINT UNSIGNED DEFAULT NULL,
  nha_cung_cap_id BIGINT UNSIGNED DEFAULT NULL,
  gia DECIMAL(12,2) NOT NULL DEFAULT 0.00,
  images TEXT DEFAULT NULL, -- JSON array của URL ảnh
  trang_thai TINYINT NOT NULL DEFAULT 1,
  FOREIGN KEY (danh_muc_id) REFERENCES danh_muc(id) ON DELETE SET NULL,
  FOREIGN KEY (nha_cung_cap_id) REFERENCES nha_cung_cap(id) ON DELETE SET NULL
) ENGINE=InnoDB CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS gio_hang (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  nguoi_dung_id BIGINT UNSIGNED DEFAULT NULL,
  ngay_tao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (nguoi_dung_id) REFERENCES nguoi_dung(id) ON DELETE SET NULL
) ENGINE=InnoDB CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS gio_hang_item (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  gio_hang_id BIGINT UNSIGNED NOT NULL,
  san_pham_id BIGINT UNSIGNED NOT NULL,
  so_luong INT UNSIGNED NOT NULL DEFAULT 1,
  don_gia DECIMAL(12,2) NOT NULL,
  FOREIGN KEY (gio_hang_id) REFERENCES gio_hang(id) ON DELETE CASCADE,
  FOREIGN KEY (san_pham_id) REFERENCES san_pham(id) ON DELETE RESTRICT
) ENGINE=InnoDB CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS don_hang (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ma_don VARCHAR(120) NOT NULL UNIQUE,
  nguoi_dung_id BIGINT UNSIGNED DEFAULT NULL,
  tong_tien DECIMAL(14,2) NOT NULL DEFAULT 0.00,
  dia_chi_giao_hang TEXT DEFAULT NULL,
  thoi_gian DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (nguoi_dung_id) REFERENCES nguoi_dung(id) ON DELETE SET NULL
) ENGINE=InnoDB CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS don_hang_item (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  don_hang_id BIGINT UNSIGNED NOT NULL,
  san_pham_id BIGINT UNSIGNED NOT NULL,
  so_luong INT UNSIGNED NOT NULL,
  don_gia DECIMAL(12,2) NOT NULL,
  thanh_tien DECIMAL(14,2) NOT NULL,
  FOREIGN KEY (don_hang_id) REFERENCES don_hang(id) ON DELETE CASCADE,
  FOREIGN KEY (san_pham_id) REFERENCES san_pham(id) ON DELETE RESTRICT
) ENGINE=InnoDB CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS kho (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(200) NOT NULL
) ENGINE=InnoDB CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS ton_kho (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  kho_id BIGINT UNSIGNED NOT NULL,
  san_pham_id BIGINT UNSIGNED NOT NULL,
  so_luong INT NOT NULL DEFAULT 0,
  FOREIGN KEY (kho_id) REFERENCES kho(id) ON DELETE CASCADE,
  FOREIGN KEY (san_pham_id) REFERENCES san_pham(id) ON DELETE CASCADE
) ENGINE=InnoDB CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS ma_giam_gia (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ma VARCHAR(100) NOT NULL UNIQUE,
  kieu ENUM('phan_tram','gia_tien') NOT NULL,
  gia_tri DECIMAL(12,2) NOT NULL,
  kich_hoat TINYINT NOT NULL DEFAULT 1
) ENGINE=InnoDB CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS thanh_toan (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  don_hang_id BIGINT UNSIGNED NOT NULL,
  hinh_thuc VARCHAR(100) DEFAULT NULL, -- COD, MOMO, VNPAY, CK...
  so_tien DECIMAL(14,2) NOT NULL DEFAULT 0.00,
  trang_thai ENUM('cho','thanh_cong','that_bai','hoan_tien') DEFAULT 'cho',
  ma_giao_dich VARCHAR(255) DEFAULT NULL,
  thong_tin TEXT DEFAULT NULL,
  thoi_gian TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (don_hang_id) REFERENCES don_hang(id) ON DELETE CASCADE
) ENGINE=InnoDB CHARSET=utf8mb4;

CREATE INDEX idx_sp_danhmuc ON san_pham(danh_muc_id);
CREATE INDEX idx_dh_user ON don_hang(nguoi_dung_id);

INSERT IGNORE INTO vaitro (ten) VALUES ('admin'), ('nguoi_dung');

SET FOREIGN_KEY_CHECKS = 1;
